<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Klasifikasi Penyakit Daun Tomat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    .dropzone { border:2px dashed #cbd5e1; transition:0.2s; }
    .dropzone.dragover { border-color:#0ea5e9; background:#f0f9ff }
    .meter { height: 10px; background:#e2e8f0; border-radius:9999px; overflow:hidden }
    .meter > span { display:block; height:100%; background:#0ea5e9 }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-6 text-center">
      <h1 class="text-2xl md:text-3xl font-semibold">🍅 Klasifikasi Penyakit Daun Tomat</h1>
      <p class="text-slate-600">Upload foto daun tomat → sistem mendeteksi jenis penyakit → tampilkan hasil beserta penjelasan dan saran penanganan.</p>
    </header>

    <section class="grid md:grid-cols-2 gap-6">
      <!-- Upload -->
      <div class="p-5 bg-white rounded-2xl shadow">
        <h2 class="font-semibold mb-2">1) Unggah Gambar</h2>
        <div id="dropzone" class="dropzone rounded-2xl p-6 flex flex-col items-center justify-center text-slate-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M3 15a4 4 0 0 0 4 4h10a4 4 0 1 0 0-8h-1.26A8 8 0 1 0 3 15z"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/>
          </svg>
          <p class="mb-2">Drag & drop atau klik untuk memilih file gambar daun tomat</p>
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
          <button id="btnPick" class="mt-2 px-3 py-2 rounded-xl bg-sky-500 text-white">Pilih File</button>
        </div>
        <div id="previewWrap" class="mt-4 hidden">
          <p class="text-sm text-slate-600 mb-1">Pratinjau</p>
          <img id="previewImg" class="rounded-xl border max-h-72 object-contain" alt="preview" />
          <div class="mt-3 text-xs text-slate-500" id="fileInfo"></div>
        </div>
        <div class="mt-4 flex flex-wrap gap-2">
          <button id="btnPredict" class="px-4 py-2 rounded-xl bg-emerald-600 text-white disabled:opacity-50" disabled>Prediksi</button>
          <button id="btnReset" class="px-4 py-2 rounded-xl bg-slate-200">Reset</button>
        </div>
        <p id="status" class="mt-3 text-sm text-slate-600"></p>
      </div>

      <!-- Hasil -->
      <div class="p-5 bg-white rounded-2xl shadow">
        <h2 class="font-semibold mb-2">2) Hasil Prediksi</h2>
        <div id="result" class="space-y-3">
          <div class="hidden" id="resMain">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-sm text-slate-500">Label:</span>
              <span id="labelId" class="inline-flex items-center px-2 py-1 rounded-full bg-sky-100 text-sky-700 text-sm font-medium"></span>
              <span id="labelEn" class="text-xs text-slate-400"></span>
            </div>
            <div>
              <div class="flex justify-between text-sm"><span>Kepercayaan</span><span id="confPct">0%</span></div>
              <div class="meter mt-1"><span id="confBar" style="width:0%"></span></div>
            </div>
          </div>

          <div class="hidden" id="resTop3">
            <h3 class="mt-4 font-medium">Top-3 Kelas</h3>
            <canvas id="chart" height="140"></canvas>
          </div>

          <div id="resInfo" class="hidden mt-2 p-3 rounded-xl bg-blue-50 border border-blue-100 text-sm text-slate-700"></div>
        </div>
      </div>
    </section>

    <!-- Riwayat -->
    <section class="mt-6 p-5 bg-white rounded-2xl shadow" id="historySection">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Riwayat Prediksi (sesi ini)</h2>
        <div class="flex gap-2">
          <button id="btnClearHistory" class="text-sm text-slate-500 hover:text-slate-700">Bersihkan</button>
          <button id="btnDownloadPDF" class="text-sm text-emerald-600 hover:text-emerald-800 font-semibold">📄 Unduh Laporan PDF</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-2">Waktu</th>
              <th>Label</th>
              <th>Conf.</th>
              <th>File</th>
              <th>Gambar</th>
            </tr>
          </thead>
          <tbody id="history"></tbody>
        </table>
      </div>
    </section>

    <footer class="mt-10 text-xs text-slate-500 text-center">
      <p>Demo Tugas Akhir – Klasifikasi Daun Tomat (MobileNetV2 + Flask API). Frontend HTML5 + TailwindCSS.</p>
    </footer>
  </div>

<script>
  const API_URL = () => 'https://clinton-dizziest-misrely.ngrok-free.dev/predict';
  const { jsPDF } = window.jspdf;

  const dz=document.getElementById('dropzone');
  const fileInput=document.getElementById('fileInput');
  const btnPick=document.getElementById('btnPick');
  const btnPredict=document.getElementById('btnPredict');
  const btnReset=document.getElementById('btnReset');
  const statusEl=document.getElementById('status');
  const previewWrap=document.getElementById('previewWrap');
  const previewImg=document.getElementById('previewImg');
  const fileInfo=document.getElementById('fileInfo');
  const labelId=document.getElementById('labelId');
  const labelEn=document.getElementById('labelEn');
  const confPct=document.getElementById('confPct');
  const confBar=document.getElementById('confBar');
  const resMain=document.getElementById('resMain');
  const resTop3=document.getElementById('resTop3');
  const resInfo=document.getElementById('resInfo');
  const histTbody=document.getElementById('history');
  const btnClearHistory=document.getElementById('btnClearHistory');
  const btnDownloadPDF=document.getElementById('btnDownloadPDF');

  let currentFile=null, chart=null, historyData=[];

  function toast(msg){statusEl.textContent=msg;setTimeout(()=>statusEl.textContent='',3000);}
  function fmtPct(x){return (x*100).toFixed(2)+'%';}
  function humanSize(bytes){const u=['B','KB','MB'];let i=0;while(bytes>=1024&&i<u.length-1){bytes/=1024;i++;}return bytes.toFixed(1)+' '+u[i];}

  const infoMap={
    "Bercak Bakteri":{desc:"Penyakit ini disebabkan oleh bakteri <em>Xanthomonas campestris</em>. Gejalanya berupa bercak cokelat gelap pada daun yang lama-kelamaan mengering dan berlubang.",advice:"Gunakan benih sehat, semprotkan bakterisida berbasis tembaga, dan hindari penyiraman berlebihan."},
    "Hawar Daun Dini":{desc:"Disebabkan oleh jamur <em>Alternaria solani</em>. Muncul bercak cokelat kehitaman berbentuk lingkaran konsentris pada daun tua.",advice:"Lakukan rotasi tanaman, buang daun terinfeksi, serta gunakan fungisida berbahan mankozeb atau klorotalonil."},
    "Hawar Daun (Late blight)":{desc:"Penyakit berat akibat <em>Phytophthora infestans</em>. Menyebabkan bercak gelap berair dan cepat menyebar ke seluruh daun bahkan buah.",advice:"Gunakan benih sehat, semprot fungisida sistemik preventif, dan hindari kelembapan tinggi."},
    "Jamur Daun (Leaf Mold)":{desc:"Disebabkan oleh jamur <em>Cladosporium fulvum</em>. Gejalanya berupa bercak kuning di atas daun dan lapisan beludru hijau keabu-abuan di bawah daun.",advice:"Perbaiki ventilasi rumah tanam, kurangi kelembapan, serta semprot fungisida preventif."},
    "Bercak Daun Septoria":{desc:"Jamur <em>Septoria lycopersici</em> menyebabkan bercak kecil berwarna abu-abu dengan tepi gelap pada daun bawah.",advice:"Hindari cipratan air ke daun, buang daun sakit, dan semprotkan fungisida kontak."},
    "Tungau Laba-laba Dua Bintik":{desc:"Hama tungau menyebabkan daun menguning, kering, dan terdapat jaring halus di permukaan bawah daun.",advice:"Semprot air pada bagian bawah daun secara rutin dan gunakan akarisida bila serangan berat."},
    "Bercak Target":{desc:"Jamur <em>Corynespora cassiicola</em> menimbulkan bercak cokelat berbentuk seperti target (lingkaran konsentris).",advice:"Sanitasi lahan, hindari kelembapan tinggi, dan gunakan fungisida protektif."},
    "Virus Kuning Keriting Daun Tomat (TYLCV)":{desc:"Disebabkan oleh virus TYLCV yang ditularkan oleh kutu kebul. Daun menggulung, menebal, dan pertumbuhan tanaman terhambat.",advice:"Kendalikan vektor dengan perangkap kuning atau insektisida, serta gunakan varietas tahan virus."},
    "Virus Mosaik Tomat (ToMV)":{desc:"Penyakit virus yang menyebabkan pola mosaik hijau muda-tua pada daun dan pertumbuhan tanaman menjadi kerdil.",advice:"Gunakan benih bebas virus, bersihkan alat pertanian dengan desinfektan, dan cabut tanaman yang terinfeksi."},
    "Sehat":{desc:"Tanaman tampak hijau segar tanpa gejala penyakit atau kerusakan fisik.",advice:"Pertahankan perawatan tanaman secara rutin, pemupukan seimbang, dan monitoring lingkungan tumbuh."},
    "Bukan daun tomat / Tidak dikenali":{desc:"Sistem mendeteksi gambar yang tidak menyerupai daun tomat atau objek tidak relevan.",advice:"Pastikan gambar fokus pada daun tomat dengan pencahayaan cukup dan latar belakang netral."}
  };

  ['dragenter','dragover'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add('dragover');}));
  ['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove('dragover');}));
  dz.addEventListener('drop',e=>{const f=e.dataTransfer.files[0];if(f)setFile(f);});
  dz.addEventListener('click',()=>fileInput.click());
  btnPick.addEventListener('click',()=>fileInput.click());
  fileInput.addEventListener('change',e=>{const f=e.target.files[0];if(f)setFile(f);});

  function setFile(f){
    if(!f.type.startsWith('image/'))return toast('File harus gambar.');
    currentFile=f;
    const url=URL.createObjectURL(f);
    previewImg.src=url;previewWrap.classList.remove('hidden');
    fileInfo.textContent=`${f.name} • ${f.type} • ${humanSize(f.size)}`;
    btnPredict.disabled=false;
  }

  btnReset.onclick=()=>{fileInput.value='';previewWrap.classList.add('hidden');btnPredict.disabled=true;};

  btnPredict.onclick=async()=>{
    if(!currentFile)return toast('Pilih gambar dulu.');
    const fd=new FormData();fd.append('file',currentFile,currentFile.name);
    btnPredict.disabled=true;toast('Memproses...');
    try{
      const res=await fetch(API_URL(),{method:'POST',body:fd});
      const j=await res.json();
      labelId.textContent=j.label_id;labelEn.textContent=`(${j.label_en})`;
      const conf=j.confidence||0;confPct.textContent=fmtPct(conf);confBar.style.width=(conf*100)+'%';
      resMain.classList.remove('hidden');
      const info=infoMap[j.label_id];
      if(info){resInfo.innerHTML=`<strong>${j.label_id}</strong><br>${info.desc}<br><br><strong>Saran Penanganan:</strong> ${info.advice}`;resInfo.classList.remove('hidden');}

      const tr=document.createElement('tr');
      const url=URL.createObjectURL(currentFile);
      tr.innerHTML=`<td>${new Date().toLocaleString()}</td><td>${j.label_id}</td><td>${fmtPct(conf)}</td><td>${currentFile.name}</td><td><img src="${url}" width="60"></td>`;
      histTbody.prepend(tr);

      historyData.push({fileName:currentFile.name,img:url,label:j.label_id,conf:fmtPct(conf),info:info});
      toast('Prediksi selesai ✅');
    }catch(e){toast('Gagal prediksi.');console.error(e);}
    finally{btnPredict.disabled=false;}
  };

  btnClearHistory.onclick=()=>{histTbody.innerHTML='';historyData=[];};

  btnDownloadPDF.onclick=async()=>{
    if(historyData.length===0)return toast('Belum ada data riwayat.');
    const pdf=new jsPDF('p','pt','a4');
    pdf.setFontSize(14);
    pdf.text("Laporan Hasil Klasifikasi Daun Tomat",40,40);
    pdf.setFontSize(10);
    pdf.text("Dibuat otomatis oleh sistem klasifikasi berbasis MobileNetV2.",40,55);

    let y=80;
    for(let i=0;i<historyData.length;i++){
      const h=historyData[i];
      pdf.text(`${i+1}. File: ${h.fileName}`,40,y);
      pdf.text(`Label: ${h.label}`,40,y+15);
      pdf.text(`Kepercayaan: ${h.conf}`,40,y+30);
      pdf.text(`Deskripsi: ${h.info.desc.replace(/<[^>]+>/g,'')}`,40,y+45,{maxWidth:500});
      pdf.text(`Saran: ${h.info.advice}`,40,y+70,{maxWidth:500});

      const img=await loadImage(h.img);
      const canvas=document.createElement('canvas');
      canvas.width=img.width;canvas.height=img.height;
      canvas.getContext('2d').drawImage(img,0,0);
      const dataURL=canvas.toDataURL('image/jpeg',0.5);
      pdf.addImage(dataURL,'JPEG',400,y-10,120,90);

      y+=120;
      if(y>700){pdf.addPage();y=50;}
    }
    pdf.save("Laporan_Prediksi_Tomat.pdf");
  };

  function loadImage(url){return new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=url;});}
</script>
</body>
</html>
