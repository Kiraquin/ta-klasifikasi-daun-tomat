<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Klasifikasi Penyakit Daun Tomat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .dropzone { border:2px dashed #cbd5e1; transition:0.2s; }
    .dropzone.dragover { border-color:#0ea5e9; background:#f0f9ff }
    .meter { height: 10px; background:#e2e8f0; border-radius:9999px; overflow:hidden }
    .meter > span { display:block; height:100%; background:#0ea5e9 }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-6 text-center">
      <h1 class="text-2xl md:text-3xl font-semibold">üçÖ Klasifikasi Penyakit Daun Tomat</h1>
      <p class="text-slate-600">Upload foto daun ‚Üí model memprediksi ‚Üí tampilkan hasil & saran ‚Üí opsional kirim via email.</p>
    </header>

    <section class="grid md:grid-cols-2 gap-6">
      <!-- Upload -->
      <div class="p-5 bg-white rounded-2xl shadow">
        <h2 class="font-semibold mb-2">1) Unggah Gambar</h2>
        <div id="dropzone" class="dropzone rounded-2xl p-6 flex flex-col items-center justify-center text-slate-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M3 15a4 4 0 0 0 4 4h10a4 4 0 1 0 0-8h-1.26A8 8 0 1 0 3 15z"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/>
          </svg>
          <p class="mb-2">Drag & drop atau klik untuk memilih file</p>
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
          <button id="btnPick" class="mt-2 px-3 py-2 rounded-xl bg-sky-500 text-white">Pilih File</button>
        </div>
        <div id="previewWrap" class="mt-4 hidden">
          <p class="text-sm text-slate-600 mb-1">Pratinjau</p>
          <img id="previewImg" class="rounded-xl border max-h-72 object-contain" alt="preview" />
          <div class="mt-3 text-xs text-slate-500" id="fileInfo"></div>
        </div>
        <div class="mt-4 flex flex-wrap gap-2">
          <button id="btnPredict" class="px-4 py-2 rounded-xl bg-emerald-600 text-white disabled:opacity-50" disabled>Prediksi</button>
          <button id="btnReset" class="px-4 py-2 rounded-xl bg-slate-200">Reset</button>
        </div>
        <p id="status" class="mt-3 text-sm text-slate-600"></p>
      </div>

      <!-- Hasil -->
      <div class="p-5 bg-white rounded-2xl shadow">
        <h2 class="font-semibold mb-2">2) Hasil Prediksi</h2>
        <div id="result" class="space-y-3">
          <div class="hidden" id="resMain">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-sm text-slate-500">Label:</span>
              <span id="labelId" class="inline-flex items-center px-2 py-1 rounded-full bg-sky-100 text-sky-700 text-sm font-medium"></span>
              <span id="labelEn" class="text-xs text-slate-400"></span>
            </div>
            <div>
              <div class="flex justify-between text-sm"><span>Kepercayaan</span><span id="confPct">0%</span></div>
              <div class="meter mt-1"><span id="confBar" style="width:0%"></span></div>
            </div>
          </div>

          <div class="hidden" id="resTop3">
            <h3 class="mt-4 font-medium">Top-3 Kelas</h3>
            <canvas id="chart" height="140"></canvas>
          </div>

          <!-- Penjelasan penyakit -->
          <div id="resInfo" class="hidden mt-2 p-3 rounded-xl bg-blue-50 border border-blue-100 text-sm text-slate-700"></div>

          <!-- Kirim email -->
          <div id="emailBlock" class="hidden pt-2 border-t">
            <label class="block text-sm font-medium mb-1">Kirim hasil ke email (opsional)</label>
            <div class="flex gap-2 items-center">
              <input id="emailInput" type="email" placeholder="nama@email.com" class="w-full px-3 py-2 border rounded-xl" />
              <button id="btnSendEmail" class="px-3 py-2 rounded-xl bg-indigo-600 text-white disabled:opacity-50" disabled>Kirim</button>
            </div>
            <p class="text-xs text-slate-500 mt-1">Email dikirim via n8n (production webhook).</p>
          </div>

          <div id="resRaw" class="text-xs text-slate-500 hidden"></div>
        </div>
      </div>
    </section>

    <!-- Riwayat -->
    <section class="mt-6 p-5 bg-white rounded-2xl shadow">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Riwayat Prediksi (sesi ini)</h2>
        <button id="btnClearHistory" class="text-sm text-slate-500 hover:text-slate-700">Bersihkan</button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-2">Waktu</th>
              <th>Label</th>
              <th>Conf.</th>
              <th>File</th>
            </tr>
          </thead>
          <tbody id="history"></tbody>
        </table>
      </div>
    </section>

    <footer class="mt-10 text-xs text-slate-500 text-center">
      <p>Demo TA ‚Äì Klasifikasi Daun Tomat (MobileNetV2 + Flask API + n8n). Frontend HTML5 + TailwindCSS.</p>
    </footer>
  </div>

<script>
  // ===== Konfigurasi endpoint (hardcode)
  const API_URL = () => 'https://clinton-dizziest-misrely.ngrok-free.dev/predict'; // Flask + ngrok
  const WEBHOOK_URL = () => 'https://projectade.app.n8n.cloud/webhook/klasifikasi-tomat'; // n8n production

  // ===== Elemen DOM =====
  const dz = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const btnPick = document.getElementById('btnPick');
  const btnPredict = document.getElementById('btnPredict');
  const btnReset = document.getElementById('btnReset');
  const statusEl = document.getElementById('status');
  const previewWrap = document.getElementById('previewWrap');
  const previewImg = document.getElementById('previewImg');
  const fileInfo = document.getElementById('fileInfo');
  const labelId = document.getElementById('labelId');
  const labelEn = document.getElementById('labelEn');
  const confPct = document.getElementById('confPct');
  const confBar = document.getElementById('confBar');
  const resMain = document.getElementById('resMain');
  const resTop3 = document.getElementById('resTop3');
  const resInfo = document.getElementById('resInfo');
  const resRaw = document.getElementById('resRaw');
  const histTbody = document.getElementById('history');
  const btnClearHistory = document.getElementById('btnClearHistory');
  const emailBlock = document.getElementById('emailBlock');
  const emailInput = document.getElementById('emailInput');
  const btnSendEmail = document.getElementById('btnSendEmail');

  let currentFile = null, currentDataUrl = null, lastResult = null, chart = null;

  // ===== Helper =====
  function toast(msg){ statusEl.textContent = msg; setTimeout(()=>statusEl.textContent='', 3000); }
  function fmtPct(x){ return (x*100).toFixed(2) + '%'; }
  function humanSize(bytes){ const u=['B','KB','MB','GB']; let i=0; while(bytes>=1024&&i<u.length-1){bytes/=1024;i++;} return bytes.toFixed(1)+' '+u[i]; }
  function fileToDataUrl(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

  // ===== Drag & Drop =====
  ;['dragenter','dragover'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add('dragover');}));
  ;['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove('dragover');}));
  dz.addEventListener('drop', e=>{ const f=e.dataTransfer.files[0]; if(f) setFile(f); });
  dz.addEventListener('click', ()=> fileInput.click());
  btnPick.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', e=>{ const f=e.target.files[0]; if(f) setFile(f); });

  async function setFile(f){
    if(!f.type.startsWith('image/')) return toast('File harus gambar.');
    currentFile=f;
    const url=URL.createObjectURL(f);
    previewImg.src=url; previewImg.onload=()=>URL.revokeObjectURL(url);
    currentDataUrl = await fileToDataUrl(f); // untuk kirim ke email (inline)
    previewWrap.classList.remove('hidden');
    btnPredict.disabled=false; fileInfo.textContent=`${f.name} ‚Ä¢ ${f.type} ‚Ä¢ ${humanSize(f.size)}`;
    // reset hasil
    lastResult=null; resMain.classList.add('hidden'); resTop3.classList.add('hidden'); resInfo.classList.add('hidden');
    emailBlock.classList.add('hidden'); btnSendEmail.disabled=true;
    confBar.style.width='0%'; confPct.textContent='0%';
  }

  btnReset.onclick=()=>{currentFile=null;currentDataUrl=null;lastResult=null;fileInput.value='';previewWrap.classList.add('hidden');btnPredict.disabled=true;resMain.classList.add('hidden');resTop3.classList.add('hidden');resInfo.classList.add('hidden');emailBlock.classList.add('hidden');btnSendEmail.disabled=true;confBar.style.width='0%';confPct.textContent='0%';labelId.textContent='';labelEn.textContent='';};

  btnClearHistory.onclick=()=>{histTbody.innerHTML='';};

  // ===== Deskripsi & saran penyakit =====
  const infoMap={
    "Bercak Bakteri":{desc:"Disebabkan oleh bakteri *Xanthomonas campestris*, menimbulkan bercak gelap pada daun dan buah.",advice:"Gunakan benih sehat, hindari kelembapan berlebih, dan aplikasikan bakterisida tembaga bila perlu."},
    "Hawar Daun Dini":{desc:"Jamur *Alternaria solani* menyebabkan bercak cokelat konsentris di daun tua.",advice:"Rotasi tanaman, sanitasi daun terinfeksi, fungisida sesuai anjuran."},
    "Hawar Daun (Late blight)":{desc:"Disebabkan oleh *Phytophthora infestans*, menyebabkan bercak basah, cepat menyebar.",advice:"Buang daun/bagian terinfeksi, gunakan fungisida preventif."},
    "Jamur Daun (Leaf Mold)":{desc:"Jamur *Cladosporium fulvum* ‚Üí bercak kuning, lapisan beludru hijau di bawah daun.",advice:"Perbaiki ventilasi, kurangi kelembapan, pilih varietas tahan."},
    "Bercak Daun Septoria":{desc:"Jamur *Septoria lycopersici* ‚Üí bintik abu-abu kecil bertepi gelap.",advice:"Pangkas daun bawah, rotasi, fungisida jika parah."},
    "Tungau Laba-laba Dua Bintik":{desc:"Hama tungau ‚Üí daun menguning & kering.",advice:"Semprot bagian bawah daun dengan air, gunakan akarisida bila perlu."},
    "Bercak Target":{desc:"Jamur *Corynespora cassiicola* ‚Üí bercak seperti target lingkaran.",advice:"Sanitasi kebun, rotasi non-inang, fungisida jika perlu."},
    "Virus Kuning Keriting Daun Tomat (TYLCV)":{desc:"Daun menguning & menggulung akibat virus TYLCV.",advice:"Kendalikan kutu kebul, gunakan mulsa perak, tanam varietas toleran."},
    "Virus Mosaik Tomat (ToMV)":{desc:"Pola mosaik hijau muda-tua, pertumbuhan terhambat.",advice:"Benih bebas virus, disinfeksi alat, buang tanaman terinfeksi."},
    "Sehat":{desc:"Tidak tampak gejala signifikan.",advice:"Pertahankan pemupukan & sanitasi rutin."},
    "Bukan daun tomat / Tidak dikenali":{desc:"Gambar bukan daun tomat atau sulit dikenali.",advice:"Pastikan foto adalah daun tomat, fokus jelas, pencahayaan baik."}
  };

  // ===== Prediksi =====
  btnPredict.onclick=async()=>{
    if(!currentFile) return toast('Pilih gambar dulu.');
    const fd=new FormData(); fd.append('file',currentFile,currentFile.name);
    btnPredict.disabled=true; toast('Mengirim ke model...');
    try{
      const res=await fetch(API_URL(),{method:'POST',body:fd});
      if(!res.ok){throw new Error(`HTTP ${res.status}: ${await res.text()}`);}
      const j=await res.json();
      lastResult = j;

      // tampilkan
      labelId.textContent=j.label_id||'-'; labelEn.textContent=j.label_en?`(${j.label_en})`:'';
      const conf=Number(j.confidence??0);
      confPct.textContent=fmtPct(conf); confBar.style.width=(conf*100).toFixed(2)+'%';
      resMain.classList.remove('hidden');

      if(j.top3){
        const labels=j.top3.map(x=>x.label_id||x.label_en);
        const data=j.top3.map(x=>Number(x.confidence||0));
        const ctx=document.getElementById('chart').getContext('2d');
        if(chart) chart.destroy();
        chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Confidence',data}]},
          options:{responsive:true,plugins:{legend:{display:false}},
          scales:{y:{beginAtZero:true,ticks:{callback:(v)=>(v*100)+'%'}}}}});
        resTop3.classList.remove('hidden');
      }

      const info=infoMap[j.label_id];
      if(info){resInfo.innerHTML=`<strong>${j.label_id}</strong>: ${info.desc}<br><br><em>Saran:</em> ${info.advice}`;resInfo.classList.remove('hidden');}
      else{resInfo.classList.add('hidden');}

      // aktifkan blok email
      emailBlock.classList.remove('hidden');
      btnSendEmail.disabled = false;

      // riwayat
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class='py-2 text-slate-500'>${new Date().toLocaleString()}</td><td>${labelId.textContent}</td><td>${confPct.textContent}</td><td>${currentFile.name}</td>`;
      histTbody.prepend(tr);

      toast('Selesai.');
    }catch(err){
      resRaw.classList.remove('hidden'); resRaw.textContent=String(err); toast('Gagal prediksi.');
    }finally{btnPredict.disabled=false;}
  };

  // ===== Kirim email via n8n (production webhook) =====
  btnSendEmail.onclick = async ()=>{
    const email = (emailInput.value||'').trim();
    if(!email){ toast('Isi email penerima dulu.'); emailInput.focus(); return; }
    if(!lastResult){ toast('Belum ada hasil prediksi.'); return; }

    btnSendEmail.disabled = true; toast('Mengirim email...');
    const payload = {
      email,
      label_id: lastResult.label_id,
      label_en: lastResult.label_en,
      confidence: lastResult.confidence,
      top3: lastResult.top3 || [],
      filename: currentFile ? currentFile.name : null,
      image_data_url: currentDataUrl, // bisa dipakai inline di body email n8n
      timestamp: new Date().toISOString()
    };

    try{
      const r = await fetch(WEBHOOK_URL(), {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!r.ok) throw new Error(`HTTP ${r.status}: ${await r.text()}`);
      toast('Email terkirim ‚úÖ');
    }catch(e){
      toast('Gagal kirim email. Cek webhook n8n.');
      console.error(e);
    }finally{
      btnSendEmail.disabled = false;
    }
  };
</script>
</body>
</html>
