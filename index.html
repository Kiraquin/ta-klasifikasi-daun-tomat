<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Klasifikasi Penyakit Daun Tomat - Ade Tri Satria</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .dropzone { border:2px dashed #cbd5e1; transition:0.2s; }
    .dropzone.dragover { border-color:#0ea5e9; background:#f0f9ff }
    .meter { height: 10px; background:#e2e8f0; border-radius:9999px; overflow:hidden }
    .meter > span { display:block; height:100%; background:#0ea5e9 }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-6 text-center">
      <h1 class="text-3xl font-semibold">üçÖ Klasifikasi Penyakit Daun Tomat</h1>
      <p class="text-slate-600">Model <strong>MobileNetV2</strong> digunakan untuk mengidentifikasi penyakit daun tomat secara otomatis.</p>
    </header>

    <section class="grid md:grid-cols-2 gap-6">
      <!-- Upload -->
      <div class="p-5 bg-white rounded-2xl shadow">
        <h2 class="font-semibold mb-2">1Ô∏è‚É£ Unggah Gambar</h2>
        <div id="dropzone" class="dropzone rounded-2xl p-6 flex flex-col items-center justify-center text-slate-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M3 15a4 4 0 0 0 4 4h10a4 4 0 1 0 0-8h-1.26A8 8 0 1 0 3 15z"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/>
          </svg>
          <p class="mb-2">Drag & drop atau klik untuk memilih file gambar daun tomat</p>
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
          <button id="btnPick" class="mt-2 px-3 py-2 rounded-xl bg-sky-500 text-white">Pilih File</button>
        </div>
        <div id="previewWrap" class="mt-4 hidden">
          <p class="text-sm text-slate-600 mb-1">Pratinjau</p>
          <img id="previewImg" class="rounded-xl border max-h-72 object-contain" alt="preview" />
          <div class="mt-3 text-xs text-slate-500" id="fileInfo"></div>
        </div>
        <div class="mt-4 flex flex-wrap gap-2">
          <button id="btnPredict" class="px-4 py-2 rounded-xl bg-emerald-600 text-white disabled:opacity-50" disabled>Prediksi</button>
          <button id="btnReset" class="px-4 py-2 rounded-xl bg-slate-200">Reset</button>
        </div>
        <p id="status" class="mt-3 text-sm text-slate-600"></p>
      </div>

      <!-- Hasil -->
      <div class="p-5 bg-white rounded-2xl shadow">
        <h2 class="font-semibold mb-2">2Ô∏è‚É£ Hasil Prediksi</h2>
        <div id="resMain" class="hidden space-y-3">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-sm text-slate-500">Label:</span>
            <span id="labelId" class="inline-flex items-center px-2 py-1 rounded-full bg-sky-100 text-sky-700 text-sm font-medium"></span>
            <span id="labelEn" class="text-xs text-slate-400"></span>
          </div>
          <div>
            <div class="flex justify-between text-sm"><span>Kepercayaan</span><span id="confPct">0%</span></div>
            <div class="meter mt-1"><span id="confBar" style="width:0%"></span></div>
          </div>
        </div>

        <div id="resTop3" class="hidden mt-4">
          <h3 class="font-medium">Top-3 Kelas</h3>
          <canvas id="chart" height="140"></canvas>
        </div>

        <div id="resInfo" class="hidden mt-2 p-3 rounded-xl bg-blue-50 border border-blue-100 text-sm text-slate-700"></div>
      </div>
    </section>

    <!-- Riwayat -->
    <section class="mt-6 p-5 bg-white rounded-2xl shadow" id="historySection">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Riwayat Prediksi (sesi ini)</h2>
        <div class="flex gap-2">
          <button id="btnClearHistory" class="text-sm text-slate-500 hover:text-slate-700">üóë Bersihkan</button>
          <button id="btnDownloadPDF" class="text-sm text-emerald-600 hover:text-emerald-800 font-semibold">üìÑ Unduh Laporan PDF</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-2">Waktu</th>
              <th>Label</th>
              <th>Conf.</th>
              <th>File</th>
              <th>Gambar</th>
            </tr>
          </thead>
          <tbody id="history"></tbody>
        </table>
      </div>
    </section>

    <footer class="mt-10 text-xs text-slate-500 text-center">
      <p>Tugas Akhir ‚Äî Klasifikasi Daun Tomat (MobileNetV2 + Flask API) <br> Ade Tri Satria ‚Ä¢ NIM: 04322025 ‚Ä¢ Universitas Narotama</p>
    </footer>
  </div>

<script>
  const API_URL = () => 'https://clinton-dizziest-misrely.ngrok-free.dev/predict';
  const { jsPDF } = window.jspdf;

  const dz=document.getElementById('dropzone');
  const fileInput=document.getElementById('fileInput');
  const btnPick=document.getElementById('btnPick');
  const btnPredict=document.getElementById('btnPredict');
  const btnReset=document.getElementById('btnReset');
  const statusEl=document.getElementById('status');
  const previewWrap=document.getElementById('previewWrap');
  const previewImg=document.getElementById('previewImg');
  const fileInfo=document.getElementById('fileInfo');
  const labelId=document.getElementById('labelId');
  const labelEn=document.getElementById('labelEn');
  const confPct=document.getElementById('confPct');
  const confBar=document.getElementById('confBar');
  const resMain=document.getElementById('resMain');
  const resTop3=document.getElementById('resTop3');
  const resInfo=document.getElementById('resInfo');
  const histTbody=document.getElementById('history');
  const btnClearHistory=document.getElementById('btnClearHistory');
  const btnDownloadPDF=document.getElementById('btnDownloadPDF');

  let currentFile=null, chart=null, historyData=[];

  function toast(msg){statusEl.textContent=msg;setTimeout(()=>statusEl.textContent='',3000);}
  function fmtPct(x){return (x*100).toFixed(2)+'%';}
  function humanSize(bytes){const u=['B','KB','MB'];let i=0;while(bytes>=1024&&i<u.length-1){bytes/=1024;i++;}return bytes.toFixed(1)+' '+u[i];}

  const infoMap={
    "Bercak Bakteri":{desc:"Disebabkan oleh bakteri Xanthomonas campestris. Gejala berupa bercak gelap pada daun yang mengering dan berlubang.",advice:"Gunakan benih sehat dan semprot bakterisida berbasis tembaga."},
    "Hawar Daun Dini":{desc:"Jamur Alternaria solani menyebabkan bercak gelap konsentris pada daun tua.",advice:"Buang daun terinfeksi dan gunakan fungisida seperti mankozeb atau klorotalonil."},
    "Hawar Daun (Late blight)":{desc:"Penyakit berat akibat Phytophthora infestans. Daun muncul bercak gelap berair yang cepat menyebar.",advice:"Gunakan fungisida sistemik dan hindari kelembapan tinggi."},
    "Jamur Daun (Leaf Mold)":{desc:"Disebabkan oleh jamur Cladosporium fulvum, menimbulkan bercak kuning di atas daun dan lapisan hijau keabu-abuan di bawah daun.",advice:"Perbaiki ventilasi rumah tanam dan semprot fungisida preventif."},
    "Bercak Daun Septoria":{desc:"Jamur Septoria lycopersici menimbulkan bercak kecil abu-abu dengan tepi gelap pada daun bawah.",advice:"Hindari cipratan air ke daun dan semprotkan fungisida kontak."},
    "Bercak Target":{desc:"Jamur Corynespora cassiicola menimbulkan bercak cokelat berbentuk target.",advice:"Sanitasi lahan dan gunakan fungisida protektif."},
    "Tungau Laba-laba Dua Bintik":{desc:"Hama tungau menyebabkan daun menguning dan terdapat jaring halus di permukaan bawah.",advice:"Gunakan akarisida bila serangan berat."},
    "Virus Kuning Keriting Daun Tomat (TYLCV)":{desc:"Virus TYLCV menyebabkan daun menggulung dan pertumbuhan terhambat.",advice:"Gunakan varietas tahan dan kendalikan kutu kebul."},
    "Virus Mosaik Tomat (ToMV)":{desc:"Virus ToMV menyebabkan pola mosaik hijau muda-tua pada daun.",advice:"Gunakan benih bebas virus dan cabut tanaman terinfeksi."},
    "Sehat":{desc:"Daun tampak hijau segar tanpa gejala penyakit.",advice:"Lanjutkan perawatan dan pemupukan rutin."},
    "Bukan daun tomat / Tidak dikenali":{desc:"Sistem mendeteksi gambar bukan daun tomat atau objek tidak relevan.",advice:"Pastikan gambar fokus pada daun tomat dengan pencahayaan cukup."}
  };

  ['dragenter','dragover'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add('dragover');}));
  ['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove('dragover');}));
  dz.addEventListener('drop',e=>{const f=e.dataTransfer.files[0];if(f)setFile(f);});
  dz.addEventListener('click',()=>fileInput.click());
  btnPick.addEventListener('click',()=>fileInput.click());
  fileInput.addEventListener('change',e=>{const f=e.target.files[0];if(f)setFile(f);});

  function setFile(f){
    if(!f.type.startsWith('image/'))return toast('File harus gambar.');
    currentFile=f;
    const url=URL.createObjectURL(f);
    previewImg.src=url;previewWrap.classList.remove('hidden');
    fileInfo.textContent=`${f.name} ‚Ä¢ ${f.type} ‚Ä¢ ${humanSize(f.size)}`;
    btnPredict.disabled=false;
  }

  btnReset.onclick=()=>{fileInput.value='';previewWrap.classList.add('hidden');btnPredict.disabled=true;resMain.classList.add('hidden');resTop3.classList.add('hidden');resInfo.classList.add('hidden');};

  btnPredict.onclick=async()=>{
    if(!currentFile)return toast('Pilih gambar dulu.');
    const fd=new FormData();fd.append('file',currentFile,currentFile.name);
    btnPredict.disabled=true;toast('Memproses...');
    try{
      const res=await fetch(API_URL(),{method:'POST',body:fd});
      const j=await res.json();

      labelId.textContent=j.label_id;labelEn.textContent=`(${j.label_en})`;
      const conf=j.confidence||0;confPct.textContent=fmtPct(conf);confBar.style.width=(conf*100)+'%';
      resMain.classList.remove('hidden');

      if(j.top3){
        const labels=j.top3.map(x=>x.label_id);
        const data=j.top3.map(x=>x.confidence);
        const ctx=document.getElementById('chart').getContext('2d');
        if(chart)chart.destroy();
        chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Confidence',data,backgroundColor:'#0ea5e9'}]},
          options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>(v*100)+'%'}}}}});
        resTop3.classList.remove('hidden');
      }

      const info=infoMap[j.label_id] || {desc:"Belum ada deskripsi.",advice:"Tidak tersedia."};
      resInfo.innerHTML=`<strong>${j.label_id}</strong><br>${info.desc}<br><br><strong>Saran Penanganan:</strong> ${info.advice}`;
      resInfo.classList.remove('hidden');

      const tr=document.createElement('tr');
      const url=URL.createObjectURL(currentFile);
      tr.innerHTML=`<td>${new Date().toLocaleString()}</td><td>${j.label_id}</td><td>${fmtPct(conf)}</td><td>${currentFile.name}</td><td><img src="${url}" width="60"></td>`;
      histTbody.prepend(tr);
      historyData.push({fileName:currentFile.name,img:url,label:j.label_id,conf:fmtPct(conf),info:info});
      toast('Prediksi selesai ‚úÖ');
    }catch(e){toast('Gagal prediksi.');console.error(e);}
    finally{btnPredict.disabled=false;}
  };

  btnClearHistory.onclick=()=>{histTbody.innerHTML='';historyData=[];};

  btnDownloadPDF.onclick=async()=>{
    if(historyData.length===0)return toast('Belum ada data riwayat.');
    const pdf=new jsPDF('p','pt','a4');
    pdf.setFontSize(14);
    pdf.text("UNIVERSITAS NAROTAMA",200,40,{align:"center"});
    pdf.setFontSize(12);
    pdf.text("LAPORAN HASIL KLASIFIKASI PENYAKIT DAUN TOMAT",200,60,{align:"center"});
    pdf.setFontSize(10);
    pdf.text("Nama: Ade Tri Satria   |   NIM: 04322025   |   Prodi: Teknik Informatika",40,85);
    pdf.text("Model: MobileNetV2 (Flask API)",40,100);

    let y=130;
    for(let i=0;i<historyData.length;i++){
      const h=historyData[i];
      const img=await loadImage(h.img);
      const canvas=document.createElement('canvas');
      canvas.width=img.width;canvas.height=img.height;
      canvas.getContext('2d').drawImage(img,0,0);
      const dataURL=canvas.toDataURL('image/jpeg',0.6);
      pdf.addImage(dataURL,'JPEG',60,y,150,110);
      y+=130;
      pdf.setFontSize(11);
      pdf.text(`${i+1}. File: ${h.fileName}`,40,y);
      pdf.setFontSize(10);
      pdf.text(`Label: ${h.label}`,40,y+15);
      pdf.text(`Kepercayaan: ${h.conf}`,40,y+30);
      const desc=pdf.splitTextToSize("Deskripsi: "+h.info.desc,460);
      const adv=pdf.splitTextToSize("Saran: "+h.info.advice,460);
      pdf.text(desc,40,y+50);
      pdf.text(adv,40,y+70+(desc.length*10));

      y+=100+(desc.length+adv.length)*6;
      if(y>720){pdf.addPage();y=60;}
    }
    pdf.save("Laporan_Klasifikasi_Tomat_AdeTriSatria.pdf");
  };

  function loadImage(url){return new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=url;});}
</script>
</body>
</html>
